<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXON - Painel Administrativo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #FF6B35;
            --secondary: #2D2D2D;
            --light: #FFFFFF;
            --dark: #161616;
            --gray: #F5F5F5;
            --success: #4CAF50;
            --warning: #FFC107;
            --error: #F44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--gray);
            color: var(--secondary);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Section */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .login-box {
            background-color: var(--light);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 0.8rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .error-message {
            color: var(--error);
            margin-top: 1rem;
            text-align: center;
        }
        
        /* Dashboard Section */
        .dashboard {
            display: none;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1.5rem;
        }
        
        .header h1 {
            color: var(--primary);
        }
        
        .logout-btn {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Search Section */
        .search-container {
            background-color: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .search-form {
            display: flex;
            gap: 1rem;
        }
        
        .search-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .search-btn {
            padding: 0 1.5rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* User Details Section */
        .user-details {
            background-color: var(--light);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: none;
        }
        
        .user-details h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .user-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .form-section {
            margin-bottom: 1.5rem;
        }
        
        .form-section h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .full-width {
            grid-column: span 2;
        }
        
        .equipment-list {
            margin-top: 1rem;
        }
        
        .equipment-item {
            background-color: var(--gray);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .action-buttons {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .save-btn {
            background-color: var(--success);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .cancel-btn {
            background-color: var(--error);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: var(--light);
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-header h2 {
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .modal-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .modal-btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .modal-btn-secondary {
            background-color: var(--gray);
            color: var(--secondary);
        }
        
        .has-account {
            margin-top: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-active {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }
        
        .status-pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning);
        }
        
        .status-inactive {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error);
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success);
            color: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1100;
        }
    </style>
</head>
<body>
    <!-- Success Message -->
    <div class="success-message" id="successMessage"></div>

    <!-- Login Section -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>AXON Admin</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Entrar</button>
                <div class="error-message" id="loginError"></div>
            </form>
        </div>
    </div>
    
    <!-- Dashboard Section -->
    <div class="dashboard container" id="dashboard">
        <div class="header">
            <h1>Painel Administrativo AXON</h1>
            <button class="logout-btn" id="logoutBtn">Sair</button>
        </div>
        
        <!-- Search Section -->
        <div class="search-container">
            <form id="searchForm" class="search-form">
                <input type="text" id="documentId" class="search-input" placeholder="Digite o ID do documento" required>
                <button type="submit" class="search-btn">Buscar</button>
            </form>
        </div>
        
        <!-- User Details Section -->
        <div class="user-details" id="userDetails">
            <h2>Detalhes do Cliente</h2>
            <form id="userForm" class="user-form">
                <!-- Basic Info -->
                <div class="form-section">
                    <h3>Informações Básicas</h3>
                    <div class="form-group">
                        <label for="nome">Nome Completo</label>
                        <input type="text" id="nome" required>
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <input type="text" id="cpf" required>
                    </div>
                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="telefone">Telefone</label>
                        <input type="text" id="telefone" required>
                    </div>
                </div>
                
                <!-- Status Info -->
                <div class="form-section">
                    <h3>Status do Cliente</h3>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" required>
                            <option value="ativo">Ativo</option>
                            <option value="pendente">Pendente</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="coberturaStatus">Status da Cobertura</label>
                        <select id="coberturaStatus" required>
                            <option value="ativa">Ativa</option>
                            <option value="em_carencia">Em Carência</option>
                            <option value="suspensa">Suspensa</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="inicioCarencia">Início da Carência</label>
                        <input type="date" id="inicioCarencia">
                    </div>
                    <div class="form-group">
                        <label for="fimCarencia">Fim da Carência</label>
                        <input type="date" id="fimCarencia">
                    </div>
                </div>
                
                <!-- Equipment Info -->
                <div class="form-section full-width">
                    <h3>Equipamentos</h3>
                    <div id="equipmentList" class="equipment-list">
                        <!-- Equipment items will be added here -->
                    </div>
                </div>
                
                <!-- Price Info -->
                <div class="form-section">
                    <h3>Valores</h3>
                    <div class="form-group">
                        <label for="valorTotal">Valor Total</label>
                        <input type="number" id="valorTotal" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="desconto">Desconto (%)</label>
                        <input type="number" id="desconto" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="valorFinal">Valor Final</label>
                        <input type="number" id="valorFinal" step="0.01" required>
                    </div>
                </div>
                
                <!-- Credentials Info -->
                <div class="form-section">
                    <h3>Credenciais</h3>
                    <div class="form-group">
                        <label>Login Criado</label>
                        <div id="hasCredentials" class="status-badge status-inactive">Não</div>
                    </div>
                    <button type="button" class="btn" id="createCredentialsBtn">Criar/Editar Credenciais</button>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="button" class="cancel-btn" id="cancelEditBtn">Cancelar</button>
                    <button type="submit" class="save-btn">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para criar/editar credenciais -->
    <div class="modal" id="userCredentialsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="credentialsModalTitle">Criar Credenciais</h2>
                <button class="close-btn" id="closeModalBtn">&times;</button>
            </div>
            <form id="credentialsForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="userEmail">E-mail</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Senha</label>
                    <input type="password" id="userPassword" required minlength="6" placeholder="Deixe em branco para manter a atual">
                </div>
                <div class="has-account" id="hasAccountInfo" style="display: none;">
                    Este usuário já possui uma conta no sistema.
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-btn modal-btn-secondary" id="cancelBtn">Cancelar</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoaoSjp7EOYv9Kc2npdX4lHjieawtU5ao",
            authDomain: "axon-ec708.firebaseapp.com",
            projectId: "axon-ec708",
            storageBucket: "axon-ec708.appspot.com",
            messagingSenderId: "403077673595",
            appId: "1:403077673595:web:a4cb91bdf662f8d8e9e8de"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginError = document.getElementById('loginError');
        const searchForm = document.getElementById('searchForm');
        const documentIdInput = document.getElementById('documentId');
        const userDetails = document.getElementById('userDetails');
        const userForm = document.getElementById('userForm');
        const createCredentialsBtn = document.getElementById('createCredentialsBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const hasCredentialsBadge = document.getElementById('hasCredentials');
        const equipmentList = document.getElementById('equipmentList');
        const userCredentialsModal = document.getElementById('userCredentialsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const credentialsForm = document.getElementById('credentialsForm');
        const userIdInput = document.getElementById('userId');
        const userEmailInput = document.getElementById('userEmail');
        const userPasswordInput = document.getElementById('userPassword');
        const hasAccountInfo = document.getElementById('hasAccountInfo');
        const credentialsModalTitle = document.getElementById('credentialsModalTitle');
        const successMessage = document.getElementById('successMessage');

        // Current document reference
        let currentUserDoc = null;

        // Função para reconstruir as credenciais de forma mais complexa
        function getAdminCredentials() {
            // Dividimos as credenciais em várias partes não óbvias
            const parts = {
                a: "br",
                b: "uno",
                c: "hp",
                d: "sv",
                e: "@gm",
                f: "ail",
                g: ".co",
                h: "m",
                i: "bar",
                j: "at",
                k: "avel",
                l: "ha"
            };
            
            // Construção do email usando partes não sequenciais
            const email = [
                parts.a + parts.b,  // "bruno"
                parts.c + parts.d  // "hpsv"
            ].join('') + [
                parts.e + parts.f,  // "@gmail"
                parts.g + parts.h   // ".com"
            ].join('');
            
            // Construção da senha usando partes não sequenciais
            const password = [
                parts.i,            // "bar"
                parts.j + parts.k,  // "atavel"
                parts.l             // "ha"
            ].join('');
            
            return { email, password };
        }

        // Função auxiliar para verificar credenciais
        function validateCredentials(inputEmail, inputPassword) {
            const { email, password } = getAdminCredentials();
            
            // Verificação adicional para evitar timing attacks
            let emailMatch = true;
            let passwordMatch = true;
            
            if (inputEmail.length !== email.length) emailMatch = false;
            if (inputPassword.length !== password.length) passwordMatch = false;
            
            for (let i = 0; i < inputEmail.length; i++) {
                if (inputEmail.charAt(i) !== email.charAt(i)) emailMatch = false;
            }
            
            for (let i = 0; i < inputPassword.length; i++) {
                if (inputPassword.charAt(i) !== password.charAt(i)) passwordMatch = false;
            }
            
            return emailMatch && passwordMatch;
        }

        // Função para criar o administrador padrão
        async function createDefaultAdmin() {
            const { email, password } = getAdminCredentials();
            
            try {
                // Verificar se o admin já existe usando uma consulta por e-mail
                const adminsQuery = await db.collection("administradores")
                    .where("email", "==", email)
                    .limit(1)
                    .get();
                
                if (adminsQuery.empty) {
                    // Criar usuário no Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const userId = userCredential.user.uid;
                    
                    // Criar documento no Firestore
                    await db.collection("administradores").doc(userId).set({
                        email: email,
                        createdAt: new Date().toISOString(),
                        isAdmin: true
                    });
                    
                    console.log("Administrador padrão criado com sucesso!");
                }
            } catch (error) {
                console.error("Erro ao verificar/criar administrador:", error);
            }
        }

        // Mostrar mensagem de sucesso
        function showSuccessMessage(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        // Chamar a função para criar/verificar o admin padrão quando a página carregar
        document.addEventListener('DOMContentLoaded', createDefaultAdmin);

        // Check auth state
        auth.onAuthStateChanged(async user => {
            if (user) {
                // Verificar se o usuário é administrador
                const adminDoc = await db.collection("administradores").doc(user.uid).get();
                
                if (adminDoc.exists) {
                    loginContainer.style.display = 'none';
                    dashboard.style.display = 'block';
                } else {
                    await auth.signOut();
                    loginError.textContent = 'Acesso restrito a administradores.';
                    loginContainer.style.display = 'flex';
                }
            } else {
                loginContainer.style.display = 'flex';
                dashboard.style.display = 'none';
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                // Verificação adicional das credenciais antes de tentar o login
                if (validateCredentials(email, password)) {
                    await auth.signInWithEmailAndPassword(email, password);
                    loginError.textContent = '';
                } else {
                    // Forçar um tempo de resposta similar ao do Firebase Auth
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    loginError.textContent = 'E-mail ou senha incorretos.';
                }
            } catch (error) {
                loginError.textContent = 'E-mail ou senha incorretos.';
                console.error("Erro de login:", error);
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Search for document
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = documentIdInput.value.trim();
            
            try {
                const doc = await db.collection('usuarios').doc(docId).get();
                
                if (doc.exists) {
                    currentUserDoc = doc;
                    displayUserDetails(doc.data());
                    userDetails.style.display = 'block';
                } else {
                    alert('Documento não encontrado!');
                    userDetails.style.display = 'none';
                }
            } catch (error) {
                console.error("Erro ao buscar documento:", error);
                alert('Erro ao buscar documento. Verifique o ID e tente novamente.');
            }
        });

        // Display user details in form
        function displayUserDetails(userData) {
            // Basic info
            document.getElementById('nome').value = userData.nome || '';
            document.getElementById('cpf').value = userData.cpf || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('telefone').value = userData.telefone || '';
            
            // Status info
            document.getElementById('status').value = userData.status || 'pendente';
            document.getElementById('coberturaStatus').value = userData.coberturaStatus || 'ativa';
            document.getElementById('inicioCarencia').value = userData.inicioCarencia || '';
            document.getElementById('fimCarencia').value = userData.fimCarencia || '';
            
            // Price info
            if (userData.price) {
                document.getElementById('valorTotal').value = userData.price.total || 0;
                document.getElementById('desconto').value = userData.price.discount || 0;
                document.getElementById('valorFinal').value = userData.price.discounted || 0;
            } else {
                document.getElementById('valorTotal').value = 0;
                document.getElementById('desconto').value = 0;
                document.getElementById('valorFinal').value = 0;
            }
            
            // Equipment list
            equipmentList.innerHTML = '';
            if (userData.equipments && userData.equipments.length > 0) {
                userData.equipments.forEach((eq, index) => {
                    const eqItem = document.createElement('div');
                    eqItem.className = 'equipment-item';
                    eqItem.innerHTML = `
                        <h4>Equipamento ${index + 1}</h4>
                        <div class="form-group">
                            <label>Tipo</label>
                            <input type="text" value="${eq.tipo || ''}" data-index="${index}" data-field="tipo">
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" value="${eq.marca || ''}" data-index="${index}" data-field="marca">
                        </div>
                        <div class="form-group">
                            <label>Modelo</label>
                            <input type="text" value="${eq.modelo || ''}" data-index="${index}" data-field="modelo">
                        </div>
                        <div class="form-group">
                            <label>Número de Série</label>
                            <input type="text" value="${eq.numeroSerie || ''}" data-index="${index}" data-field="numeroSerie">
                        </div>
                        <div class="form-group">
                            <label>Valor</label>
                            <input type="number" step="0.01" value="${eq.valor || 0}" data-index="${index}" data-field="valor">
                        </div>
                    `;
                    equipmentList.appendChild(eqItem);
                });
            }
            
            // Credentials info
            if (userData.uid) {
                hasCredentialsBadge.textContent = 'Sim';
                hasCredentialsBadge.className = 'status-badge status-active';
            } else {
                hasCredentialsBadge.textContent = 'Não';
                hasCredentialsBadge.className = 'status-badge status-inactive';
            }
        }

        // Save user details
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentUserDoc) return;
            
            try {
                // Collect basic info
                const updatedData = {
                    nome: document.getElementById('nome').value,
                    cpf: document.getElementById('cpf').value,
                    email: document.getElementById('email').value,
                    telefone: document.getElementById('telefone').value,
                    status: document.getElementById('status').value,
                    coberturaStatus: document.getElementById('coberturaStatus').value,
                    inicioCarencia: document.getElementById('inicioCarencia').value || null,
                    fimCarencia: document.getElementById('fimCarencia').value || null,
                    updatedAt: new Date().toISOString()
                };
                
                // Collect price info
                const total = parseFloat(document.getElementById('valorTotal').value) || 0;
                const discount = parseFloat(document.getElementById('desconto').value) || 0;
                const discounted = parseFloat(document.getElementById('valorFinal').value) || 0;
                
                updatedData.price = {
                    total: total,
                    discount: discount,
                    discounted: discounted
                };
                
                // Collect equipment info
                const equipmentInputs = document.querySelectorAll('[data-index]');
                const equipments = [];
                
                equipmentInputs.forEach(input => {
                    const index = parseInt(input.dataset.index);
                    const field = input.dataset.field;
                    const value = input.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                    
                    if (!equipments[index]) {
                        equipments[index] = {};
                    }
                    
                    equipments[index][field] = value;
                });
                
                updatedData.equipments = equipments.filter(eq => eq);
                
                // Update document
                await db.collection('usuarios').doc(currentUserDoc.id).update(updatedData);
                showSuccessMessage('Dados atualizados com sucesso!');
                
                // Refresh displayed data
                const updatedDoc = await db.collection('usuarios').doc(currentUserDoc.id).get();
                currentUserDoc = updatedDoc;
                displayUserDetails(updatedDoc.data());
            } catch (error) {
                console.error("Erro ao atualizar documento:", error);
                alert('Erro ao atualizar documento. Tente novamente.');
            }
        });

        // Cancel edit
        cancelEditBtn.addEventListener('click', () => {
            if (currentUserDoc) {
                displayUserDetails(currentUserDoc.data());
            }
        });

        // Open credentials modal
        createCredentialsBtn.addEventListener('click', () => {
            if (!currentUserDoc) return;
            
            const userData = currentUserDoc.data();
            userIdInput.value = currentUserDoc.id;
            userEmailInput.value = userData.email || '';
            userPasswordInput.value = '';
            
            if (userData.uid) {
                credentialsModalTitle.textContent = 'Alterar Credenciais';
                hasAccountInfo.style.display = 'block';
                userPasswordInput.placeholder = 'Deixe em branco para manter a senha atual';
            } else {
                credentialsModalTitle.textContent = 'Criar Credenciais';
                hasAccountInfo.style.display = 'none';
                userPasswordInput.placeholder = 'Digite a senha';
            }
            
            userCredentialsModal.style.display = 'flex';
        });

        // Modal events
        closeModalBtn.addEventListener('click', () => {
            userCredentialsModal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            userCredentialsModal.style.display = 'none';
        });

        // Criar/atualizar credenciais para usuário
        credentialsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userId = userIdInput.value;
            const email = userEmailInput.value;
            const password = userPasswordInput.value;
            
            try {
                // Verificar se o usuário já tem uma conta
                const userDoc = await db.collection('usuarios').doc(userId).get();
                const userData = userDoc.data();
                
                if (userData.uid) {
                    // Usuário já tem conta, atualizar e-mail/senha
                    if (email !== userData.email) {
                        await auth.updateEmail(userData.uid, email);
                    }
                    
                    // Atualizar senha apenas se foi fornecida
                    if (password) {
                        await auth.updatePassword(userData.uid, password);
                    }
                    
                    // Atualizar Firestore
                    await db.collection('usuarios').doc(userId).update({
                        email: email,
                        authUpdatedAt: new Date().toISOString()
                    });
                    
                    showSuccessMessage('Credenciais atualizadas com sucesso!');
                } else {
                    // Criar nova conta no Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const uid = userCredential.user.uid;
                    
                    // Atualizar documento no Firestore com UID e credenciais
                    await db.collection('usuarios').doc(userId).update({
                        uid: uid,
                        email: email,
                        authCreatedAt: new Date().toISOString()
                    });
                    
                    showSuccessMessage('Credenciais criadas com sucesso!');
                }
                
                userCredentialsModal.style.display = 'none';
                
                // Atualizar exibição
                const updatedDoc = await db.collection('usuarios').doc(userId).get();
                currentUserDoc = updatedDoc;
                displayUserDetails(updatedDoc.data());
            } catch (error) {
                console.error("Erro ao criar/atualizar credenciais:", error);
                alert('Erro ao criar/atualizar credenciais: ' + error.message);
            }
        });

        // Calculate final price when discount changes
        document.getElementById('desconto').addEventListener('input', (e) => {
            const total = parseFloat(document.getElementById('valorTotal').value) || 0;
            const discount = parseFloat(e.target.value) || 0;
            const discounted = total - (total * discount / 100);
            document.getElementById('valorFinal').value = discounted.toFixed(2);
        });

        // Calculate discount when final price changes
        document.getElementById('valorFinal').addEventListener('input', (e) => {
            const total = parseFloat(document.getElementById('valorTotal').value) || 0;
            const discounted = parseFloat(e.target.value) || 0;
            const discount = total > 0 ? ((total - discounted) / total * 100) : 0;
            document.getElementById('desconto').value = discount.toFixed(2);
        });
    </script>
</body>
</html>
